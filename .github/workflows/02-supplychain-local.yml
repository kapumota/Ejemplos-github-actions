name: Supply Chain (SBOM, SCA, Scan) — Local Only

on:
  push:
    branches: [ main ]
    paths:
      - '**/Dockerfile'
      - '**/*.py'
      - '**/requirements*.txt'
      - '.github/workflows/02-supplychain-local.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  supplychain:
    runs-on: ubuntu-latest
    permissions: {}  # sin GITHUB_TOKEN con permisos
    env:
      IMAGE_LOCAL: ci-lab:${{ github.sha }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python (para SCA)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install tools (pip-audit, syft, grype)
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Build local image (no registry)
        run: docker build -t "$IMAGE_LOCAL" .

      - name: SBOM (SPDX JSON)
        run: |
          mkdir -p .evidence
          syft "$IMAGE_LOCAL" -o spdx-json > .evidence/sbom.spdx.json

      - name: Grype scan (no fail por defecto)
        run: grype "$IMAGE_LOCAL" -o sarif > .evidence/grype.sarif || true

      - name: pip-audit (SCA deps Python)
        run: |
          if ls **/requirements*.txt >/dev/null 2>&1; then
            pip-audit -r requirements.txt -f json -o .evidence/pip-audit.json || true
          else
            echo '{}' > .evidence/pip-audit.json
          fi

      # Nota: si quisieras subir evidencias como artefactos,
      # añade un paso con actions/upload-artifact y otorga únicamente:
      # permissions: { actions: write, contents: read }
      # Mantenerlo fuera evita usar GITHUB_TOKEN implícito.
